---
import { Footer, ThemeProvider } from 'astro-pure/components/basic'
import Header from '@/components/MyHeader.astro'
import type { SiteMeta } from 'astro-pure/types'
import BaseHead from '@/components/BaseHead.astro'
import config from '@/site-config'

import { ClientRouter } from 'astro:transitions';

// Import the global.css file here so that it is included on
// all pages through the use of the <BaseLayout /> component.
import '@/assets/styles/global.css'
import '@/assets/styles/app.css'


interface Props {
  meta: SiteMeta
  highlightColor?: string
}

const {
  meta: { articleDate, description = config.description, ogImage, title },
  highlightColor = '#659EB9', // 加了个默认色
  ...props
} = Astro.props
---

<html lang={config.locale.lang}>
  <head>
    <BaseHead {articleDate} {description} {ogImage} {title} />
    <ThemeProvider />
     <!-- 开启无刷新跳转 -->
    <ClientRouter />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    <script is:inline src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
    <script is:inline src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
  </head>

  <body class='flex justify-center bg-background text-foreground' {...props}>
    {
      highlightColor && (
        <div
          id='highlight-gradient'
          class='pointer-events-none absolute start-0 top-0 z-0 h-screen w-full opacity-25'
          style={`background-image:linear-gradient(${highlightColor},transparent)`}
        />
      )
    }
    <div
      class='w-full max-w-[70rem] px-4 sm:px-7 lg:px-10 min-h-[100dvh] flex flex-col justify-between'
    >
      <Header />
      <div class='flex-1 w-full'>
        <slot />
      </div>
      <Footer />
    </div>

    {/* Set highlight color */}
    <style define:vars={{ highlightColor }}>
      :global(.highlight) {
        --highlight-fg: color-mix(
          in srgb,
          var(--highlightColor) 40%,
          hsl(var(--foreground)/var(--un-text-opacity, 1))
        );
        color: var(--highlight-fg, hsl(var(--primary) / var(--un-text-opacity))) !important;
      }
      :global(.highlight-bg) {
        background-color: var(
          --highlightColor,
          hsl(var(--primary) / var(--un-text-opacity))
        ) !important;
      }

        /* 水墨粒子样式 */
      :global(.click-particle) {
        position: fixed;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 99999;
        border-radius: 50%;
        
        /* 核心魔法：加上模糊，模拟墨迹晕开 */
        filter: blur(1px); 
        
        /* 动画：慢慢扩散并消失，像烟雾一样 */
        animation: ink-spread 1.2s ease-out forwards;
      }

      /* 动画关键帧：扩散 -> 悬停 -> 烟消云散 */
      @keyframes ink-spread {
        0% {
          opacity: 0.6; /* 初始有点浓 */
          transform: translate(var(--x), var(--y)) scale(0.2);
        }
        30% {
          opacity: 0.4;
          transform: translate(calc(var(--x) + var(--dx)), calc(var(--y) + var(--dy))) scale(1);
        }
        100% {
          opacity: 0;
          /* 向上飘一点，像烟一样 */
          transform: translate(calc(var(--x) + var(--dx) * 1.2), calc(var(--y) + var(--dy) - 20px)) scale(1.5);
        }
      }

      /* 颜色：白天是淡墨色，晚上是淡白烟 */
      :global(.click-particle) {
        background: rgba(0, 0, 0, 0.5); /* 50%透明的黑墨 */
      }
      :global(.dark .click-particle) {
        background: rgba(255, 255, 255, 0.4); /* 40%透明的白烟 */
      }
    </style>

    <script>
      (function () {
        function createParticle(x, y, angle, distance, delay) {
          setTimeout(() => {
            const particle = document.createElement('div');
            particle.className = 'click-particle';

            const size = Math.random() * 4 + 4; 
            const dx = Math.cos(angle) * distance;
            const dy = Math.sin(angle) * distance;

            // ✨ 核心魔法：随机生成不规则圆角 (30% - 70% 之间随机)
            // 这会让每个粒子都长得像不一样的小石头/墨点
            const r1 = Math.floor(Math.random() * 40 + 30);
            const r2 = Math.floor(Math.random() * 40 + 30);
            const r3 = Math.floor(Math.random() * 40 + 30);
            const r4 = Math.floor(Math.random() * 40 + 30);
            const borderRadius = `${r1}% ${100-r1}% ${r2}% ${100-r2}% / ${r3}% ${r4}% ${100-r4}% ${100-r3}%`;

            particle.style.setProperty('--x', x + 'px');
            particle.style.setProperty('--y', y + 'px');
            particle.style.setProperty('--dx', dx + 'px');
            particle.style.setProperty('--dy', dy + 'px');
            
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            // 应用不规则形状
            particle.style.borderRadius = borderRadius; 

            document.body.appendChild(particle);

            setTimeout(() => {
              particle.remove();
            }, 1200);
          }, delay);
        }

        document.addEventListener('click', (e) => {
          // 粒子数量稍微减少，更清爽
          const particleCount = 8; 
          const baseDistance = 25;
          
          for (let i = 0; i < particleCount; i++) {
            const angle = Math.random() * Math.PI * 2;
            const distance = baseDistance + Math.random() * 10;
            // 随机延迟，不像之前那么整齐，更有泼墨的感觉
            createParticle(e.clientX, e.clientY, angle, distance, Math.random() * 100);
          }
        });
      })();

// ===================
 // 平滑滚动
 // ============  
      import Lenis from 'lenis' 

      const lenis = new Lenis({
        duration: 1.9, // 滚动持续时间，越长越慢越慵懒
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // 缓动曲线
        smoothWheel: true,
      })

      function raf(time) {
        lenis.raf(time)
        requestAnimationFrame(raf)
      }

      requestAnimationFrame(raf) 


    </script>

    <!-- 1. 播放器本体 -->
    <!-- 加上 transition:persist，保证切页面不销毁 -->
    <div 
      id="player-wrapper" 
      transition:persist="player-wrapper"
      class="fixed bottom-20 left-6 z-50 w-[300px] opacity-0 scale-90 pointer-events-none transition-all duration-300 origin-bottom-left"
    >
      <div id="aplayer"></div>
    </div>

    <!-- 2. 悬浮开关按钮 -->
    <!-- 加上 transition:persist，保证事件绑定不丢失 -->
    <div 
      id="player-toggle" 
      transition:persist="player-toggle"
      class="fixed bottom-6 left-6 z-50 flex items-center justify-center size-12 rounded-full bg-background/80 backdrop-blur-md border border-border/50 shadow-lg cursor-pointer transition-transform hover:scale-110 active:scale-95 group"
    >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="size-5 text-primary group-hover:text-foreground transition-colors" id="music-icon">
        <path d="M9 18V5l12-2v13"></path>
        <circle cx="6" cy="18" r="3"></circle>
        <circle cx="18" cy="16" r="3"></circle>
      </svg>
    </div>

    <script is:inline>
      // 核心逻辑：全站只运行一次
      if (!window.ap) {
        fetch('https://api.i-meto.com/meting/api?server=tencent&type=playlist&id=9629658951')
          .then(res => res.json())
          .then(data => {
            window.ap = new APlayer({
              container: document.getElementById('aplayer'),
              fixed: false, // 保持普通模式，这样列表才能展开
              listFolded: true,
              order: 'random',
              theme: '#659EB9',
              preload: 'auto',
              audio: data
            });

            // 监听播放状态，旋转按钮
            window.ap.on('play', () => {
              const btn = document.getElementById('player-toggle');
              if(btn) btn.classList.add('music-playing');
            });
            window.ap.on('pause', () => {
              const btn = document.getElementById('player-toggle');
              if(btn) btn.classList.remove('music-playing');
            });
          });

        // 绑定点击事件 (只绑一次，因为按钮是持久化的)
        const toggleBtn = document.getElementById('player-toggle');
        const wrapper = document.getElementById('player-wrapper');
        if (toggleBtn) {
          toggleBtn.onclick = (e) => {
            e.stopPropagation();
            wrapper.classList.toggle('show');
          };
          document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target) && !toggleBtn.contains(e.target)) {
              wrapper.classList.remove('show');
            }
          });
        }
      }
    </script>

    <style is:global>
      /* 显示状态 */
      #player-wrapper.show {
        opacity: 1;
        transform: scale(1);
        pointer-events: all;
      }

      /* 播放器容器样式 - 极简版 */
      /* 我们只给它加阴影和圆角，不改内部结构，保留 APlayer 原生体验 */
      #player-wrapper #aplayer {
        background: var(--card-bg, #fff);
        border-radius: 12px;
        box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
        /* 注意：千万不能加 overflow: hidden，否则列表弹不出来 */
      }

      /* 旋转动画 */
      @keyframes spin-slow {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .music-playing #music-icon {
        animation: spin-slow 3s linear infinite;
      }

      /* 暗黑模式简单的背景适配 */
      .dark #player-wrapper #aplayer {
        background: #18181b;
      }
      .dark .aplayer-info { color: #fff !important; }
      .dark .aplayer .aplayer-lrc p { color: #a1a1aa !important; }
    </style>

</html>

